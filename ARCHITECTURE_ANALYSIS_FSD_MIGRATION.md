# Архитектурный анализ Giki и план миграции на Feature-Sliced Design

## 1. Общий обзор текущей архитектуры

### 1.1. Тип приложения и стек технологий
- **Фреймворк**: Next.js 15+ с App Router
- **Язык**: TypeScript
- **UI**: React.js 19 с Tailwind CSS, shadcn/ui и Radix UI
- **База данных**: PostgreSQL (прямые SQL запросы)
- **Аутентификация**: Web3 с ethers.js и JWT
- **AI компоненты**: OpenAI API для переводов
- **Интеграция**: GitHub API для синхронизации

### 1.2. Текущая структура директорий
```
/
├── app/                    # Next.js App Router страницы и API роуты
│   ├── api/                # Серверные API эндпоинты
│   ├── admin/              # Админ-панель
│   ├── create/             # Создание страниц
│   ├── dashboard/          # Дашборд
│   ├── pages/              # Просмотр страниц
│   ├── search/             # Поиск
│   └── settings/           # Настройки пользователя
├── components/             # React компоненты
│   ├── editor/             # Компоненты редактора
│   ├── translate/          # Компоненты для перевода
│   └── ui/                 # UI компоненты
├── hooks/                  # React хуки
├── lib/                    # Утилиты и сервисы
├── init-db/                # SQL скрипты для БД
├── types/                  # TypeScript типы
├── styles/                 # CSS стили
└── public/                 # Статические файлы
```

### 1.3. Текущие паттерны работы с данными
- Прямые SQL запросы к PostgreSQL через node-postgres (Pool)
- Сервисные функции в директории `/lib`
- API-роуты в `/app/api`
- Отсутствие единого подхода к состоянию (использование React Context, useState)
- Отсутствие слоя абстракции для работы с API на клиенте

### 1.4. Аутентификация и авторизация
- Web3 аутентификация через подписание сообщений (ethers.js)
- JWT токены для поддержания сессии
- Middleware для защиты маршрутов
- Роли пользователей (admin, editor, viewer)

### 1.5. Основные бизнес-сущности
- User (пользователь)
- Page (wiki-страница)
- PageVersion (версия страницы)
- TranslatedContent (переведенный контент)
- Settings (настройки системы)
- Session (сессия пользователя)

## 2. Принципы Feature-Sliced Design

### 2.1. Основные слои FSD
1. **app** - композиция приложения, точка входа
2. **pages** - страницы приложения
3. **widgets** - композиции компонентов для страниц
4. **features** - интерактивные части интерфейса, отвечающие за действия пользователя
5. **entities** - бизнес-сущности
6. **shared** - переиспользуемые модули и утилиты

### 2.2. Принципы организации каждого слоя
- Слои могут использовать только нижележащие слои (односторонняя зависимость)
- Каждый слой разделен на сегменты (связанные с конкретными бизнес-сущностями или функциональностью)
- Модули внутри слоя не зависят друг от друга
- Публичный API для модулей через index.ts

### 2.3. Адаптация FSD для Next.js App Router
- Совмещение `/app` роутера Next.js со слоем `pages` FSD
- Использование клиентских и серверных компонентов в соответствующих слоях
- API-роуты в отдельной директории внутри слоя `shared` или специальном слое `api`

## 3. Анализ компонентов и страниц для миграции

### 3.1. Страницы (`/app`)
- **Домашняя страница** (`app/page.tsx`)
  - Отображение последних и популярных страниц
  - Компоненты: RecentPages, PopularPages
- **Страница вики** (`app/pages/[id]/page.tsx`) 
  - Просмотр wiki-страницы
  - Компоненты: для отображения markdown, истории версий
- **Создание страницы** (`app/create/page.tsx`)
  - Форма создания новой страницы
  - Компоненты: редактор markdown
- **Настройки** (`app/settings/`)
  - Настройки профиля, предпочтений и безопасности
- **Поиск** (`app/search/page.tsx`)
  - Поиск по страницам и контенту

### 3.2. Компоненты (`/components`)
- **Header** (`components/header.tsx`) - Заголовок сайта
- **Sidebar** (`components/sidebar.tsx`) - Боковая панель навигации
- **MarkdownEditor** (`components/markdown-editor.tsx`) - Редактор Markdown
- **Web3Provider** (`components/web3-provider.tsx`) - Провайдер Web3
- **AuthProvider** (`components/auth-provider.tsx`) - Провайдер аутентификации
- **VersionHistory** (`components/version-history.tsx`) - История версий страницы
- **RecentPages** (`components/recent-pages.tsx`) - Последние страницы
- **PopularPages** (`components/popular-pages.tsx`) - Популярные страницы
- **UI компоненты** (`components/ui/`) - Базовые UI компоненты

### 3.3. Сервисы (`/lib`)
- **page-service.ts** - Работа со страницами
- **user-service.ts** - Работа с пользователями
- **session-service.ts** - Работа с сессиями
- **settings-service.ts** - Работа с настройками
- **jwt.ts** - Работа с JWT токенами
- **db.ts** - Работа с базой данных
- **github.ts** - Интеграция с GitHub
- **openai.ts** - Интеграция с OpenAI
- **web3.ts** - Работа с Web3

### 3.4. API эндпоинты (`/app/api`)
- **pages/** - API для работы со страницами
- **auth/** - API аутентификации
- **users/** - API для работы с пользователями
- **translate/** - API переводов
- **github/** - API для GitHub интеграции
- **settings/** - API настроек
- **upload/** - API загрузки файлов

## 4. Целевая структура FSD

### 4.1. Общая структура
```
/
├── app/                    # Next.js App Router
│   └── [все страницы и роуты]
├── src/                    # Исходный код (FSD)
│   ├── app/                # Точка входа (providers, глобальный конфиг)
│   ├── pages/              # Композиция страниц
│   ├── widgets/            # Композиционные блоки
│   ├── features/           # Функциональные блоки
│   ├── entities/           # Бизнес-сущности
│   ├── shared/             # Общие модули
│   └── api/                # API слой (опционально)
└── [остальные директории]
```

### 4.2. Детальная структура FSD слоев

#### 4.2.1. Слой `app`
```
/src/app/
├── providers/              # Глобальные провайдеры
│   ├── web3/               # Web3 провайдер
│   ├── auth/               # Аутентификация
│   ├── theme/              # Тема
│   └── index.ts            # Композиция провайдеров
├── styles/                 # Глобальные стили
└── index.ts                # Точка входа
```

#### 4.2.2. Слой `pages`
```
/src/pages/
├── home/                   # Домашняя страница
├── wiki-page/              # Страница wiki
├── create-page/            # Создание страницы
├── search/                 # Поиск
├── settings/               # Настройки
├── admin/                  # Админка
└── dashboard/              # Дашборд
```

#### 4.2.3. Слой `widgets`
```
/src/widgets/
├── header/                 # Шапка сайта
├── sidebar/                # Боковая навигация
├── footer/                 # Подвал сайта
├── recent-pages/           # Виджет последних страниц
├── popular-pages/          # Виджет популярных страниц
├── page-content/           # Виджет содержимого страницы
└── version-history/        # Виджет истории версий
```

#### 4.2.4. Слой `features`
```
/src/features/
├── auth/                   # Аутентификация
│   ├── web3-connect/       # Подключение Web3
│   └── sign-message/       # Подписание сообщений
├── page/                   # Фичи работы со страницами
│   ├── create/             # Создание страницы
│   ├── edit/               # Редактирование страницы
│   ├── delete/             # Удаление страницы
│   └── translate/          # Перевод страницы
├── search/                 # Поиск
└── settings/               # Настройки пользователя
```

#### 4.2.5. Слой `entities`
```
/src/entities/
├── user/                   # Пользователь
│   ├── model/              # Модель данных
│   ├── ui/                 # UI компоненты
│   └── api/                # API методы
├── page/                   # Страница wiki
│   ├── model/              # Модель данных
│   ├── ui/                 # UI компоненты
│   └── api/                # API методы
├── page-version/           # Версия страницы
└── translation/            # Перевод
```

#### 4.2.6. Слой `shared`
```
/src/shared/
├── api/                    # API клиент и утилиты
├── config/                 # Конфигурация
├── lib/                    # Библиотеки
│   ├── db/                 # Работа с БД
│   ├── jwt/                # Работа с JWT
│   ├── github/             # GitHub интеграция
│   └── openai/             # OpenAI интеграция
├── ui/                     # UI компоненты
│   ├── button/             # Кнопка
│   ├── input/              # Поле ввода
│   └── [другие базовые UI]
└── utils/                  # Утилиты
```

### 4.3. Структура файлов внутри модуля
```
/src/features/page/create/
├── index.ts                # Публичный API
├── model/                  # Бизнес-логика и состояние
│   ├── slice.ts            # Zustand slice
│   ├── types.ts            # TypeScript типы
│   └── constants.ts        # Константы
├── ui/                     # UI компоненты
│   ├── CreatePageForm.tsx  # Форма создания страницы
│   └── index.ts            # Экспорт компонентов
└── lib/                    # Вспомогательная логика
    └── validators.ts       # Валидаторы
```

## 5. План миграции на FSD

### 5.1. Подготовительные шаги
1. **Аудит зависимостей**
   - Установка Zustand для управления состоянием
   - Добавление react-query/SWR для управления серверным состоянием
   - Установка zod для валидации данных

2. **Создание базовой структуры FSD**
   - Создание директории `/src` и основных слоев
   - Перенос глобальных стилей и конфигураций

3. **Отбор компонентов для миграции по приоритету**
   - Начать с core компонентов (auth, user)
   - Далее мигрировать компоненты страниц
   - В конце перенести вспомогательные утилиты

### 5.2. Детальный план миграции по слоям

#### 5.2.1. Создание слоя `shared`
1. **Миграция UI компонентов**
   - Перенос всех базовых UI из `/components/ui` в `/src/shared/ui`
   - Адаптация компонентов для экспорта через публичный API

2. **Создание API-клиента**
   - Создание единого API-клиента с типами
   - Типизация всех запросов и ответов с использованием zod

3. **Миграция утилит**
   - Перенос функций из `/lib` в соответствующие модули `/src/shared/lib`
   - Создание правильных публичных API для каждого модуля

#### 5.2.2. Создание слоя `entities`
1. **Определение основных бизнес-сущностей**
   - User, Page, PageVersion, Translation и др.

2. **Для каждой сущности**:
   - Создать структуру `model/ui/api`
   - Определить модель данных и типы
   - Мигрировать UI компоненты 
   - Создать методы работы с API

#### 5.2.3. Создание слоя `features`
1. **Идентификация основных фич**
   - Аутентификация, CRUD для страниц, переводы и др.

2. **Для каждой фичи**:
   - Создать папку с моделью, UI и вспомогательными функциями
   - Мигрировать соответствующие компоненты
   - Интегрировать с сущностями из `entities`

#### 5.2.4. Создание слоя `widgets`
1. **Миграция композиционных компонентов**
   - Header, Sidebar, RecentPages и др.
   - Интеграция с фичами и сущностями

#### 5.2.5. Создание слоя `pages`
1. **Для каждой страницы**:
   - Создать модуль в `/src/pages`
   - Использовать компоненты из `widgets` и `features`
   - Интегрировать с соответствующим роутом в `/app`

#### 5.2.6. Создание слоя `app`
1. **Миграция провайдеров**
   - Перенос Web3Provider, AuthProvider и др.
   - Настройка глобальных провайдеров состояния

### 5.3. Миграция серверных компонентов
1. **Сохранение серверной логики в API-эндпоинтах**
   - API-роуты остаются в `/app/api`
   - Модули в `/src/entities/*/api` используются для типизации и клиентского API

2. **Миграция сервисных функций**
   - Логика из `/lib` мигрирует в соответствующие модули в `shared/lib` или `entities/*/model`

### 5.4. Миграция данных и состояния
1. **Создание Zustand store для глобального состояния**
   - Определение слайсов для основных сущностей
   - Миграция с React Context на Zustand

2. **Интеграция с React Query/SWR**
   - Типизированные хуки для работы с API
   - Кэширование данных и инвалидация

3. **Валидация данных**
   - Схемы Zod для всех данных
   - Интеграция с React Hook Form

## 6. Подробный анализ компонентов для миграции

### 6.1. Компоненты визуального интерфейса

#### 6.1.1. Header (`components/header.tsx`)
- **Текущие зависимости**: AuthContext, NextLink
- **Миграция**:
  - Новый путь: `src/widgets/header`
  - Использует фичи: `auth`, `search`
  - Разделить на подкомпоненты: Logo, NavMenu, UserMenu

#### 6.1.2. Sidebar (`components/sidebar.tsx`)
- **Текущие зависимости**: AuthContext, NavLinks
- **Миграция**:
  - Новый путь: `src/widgets/sidebar`
  - Использует: `entities/navigation`, `features/auth`

#### 6.1.3. MarkdownEditor (`components/markdown-editor.tsx`)
- **Текущие зависимости**: CodeMirror, React-Markdown
- **Миграция**:
  - Новый путь: `src/features/page/edit/ui/MarkdownEditor`
  - Модель: состояние редактора, валидация
  - Подкомпоненты: Toolbar, Preview, EditorPane

### 6.2. Провайдеры и контексты

#### 6.2.1. Web3Provider (`components/web3-provider.tsx`)
- **Текущие зависимости**: ethers.js, React.Context
- **Миграция**:
  - Новый путь: `src/app/providers/web3`
  - Разделить на: модель (store), UI (провайдер)
  - Использует: `shared/lib/web3`

#### 6.2.2. AuthProvider (`components/auth-provider.tsx`)
- **Миграция**:
  - Новый путь: `src/app/providers/auth`
  - Интегрировать с Web3Provider
  - Использовать Zustand для состояния

### 6.3. Сервисы и утилиты

#### 6.3.1. page-service.ts
- **Миграция**:
  - Базовый слой: `src/entities/page/model`
  - API методы: `src/entities/page/api`
  - Типы: `src/entities/page/model/types.ts`

#### 6.3.2. user-service.ts
- **Миграция**:
  - Базовый слой: `src/entities/user/model`
  - API методы: `src/entities/user/api`

#### 6.3.3. db.ts
- **Миграция**:
  - Новый путь: `src/shared/lib/db`
  - Создание абстракций и интерфейсов
  - Внедрение паттернов для работы с БД

## 7. План тестирования и валидации миграции

### 7.1. Стратегия тестирования
1. **Unit-тесты**
   - Проверка отдельных компонентов и функций
   - Миграция существующих тестов

2. **Integration-тесты**
   - Проверка взаимодействия между слоями
   - Фокус на ключевой функциональности

3. **E2E тесты**
   - Проверка основных пользовательских сценариев
   - Использование Cypress/Playwright

### 7.2. Процесс валидации
1. **Пошаговая валидация**
   - После миграции каждого модуля
   - Сравнение поведения до и после

2. **Параллельная работа старой и новой архитектуры**
   - Использование feature flags
   - Постепенный переход на новую архитектуру

## 8. Организация процесса миграции

### 8.1. Поэтапный процесс
1. **Подготовка**
   - Создание структуры FSD
   - Настройка инструментов

2. **Миграция слоя shared**
   - UI компоненты
   - Утилиты и библиотеки

3. **Миграция слоя entities**
   - Основные бизнес-сущности
   - Модели данных

4. **Миграция features и widgets**
   - Функциональные блоки
   - Композиционные компоненты

5. **Миграция pages и app**
   - Страницы приложения
   - Глобальные провайдеры

### 8.2. Критические моменты и риски
1. **Совместимость с Next.js App Router**
   - Особенности работы с серверными компонентами
   - Взаимодействие с API Routes

2. **Производительность**
   - Избегание дублирования кода
   - Оптимизация импортов

3. **Состояние приложения**
   - Миграция с Context API на Zustand
   - Сохранение консистентности данных

## 9. Выводы и рекомендации

### 9.1. Ключевые преимущества перехода на FSD
- Улучшенная масштабируемость и поддерживаемость
- Четкое разделение ответственности
- Упрощение командной разработки
- Повышение переиспользуемости кода

### 9.2. Дальнейшие шаги после миграции
- Документирование архитектуры
- Оптимизация производительности
- Расширение тестового покрытия
- Внедрение статического анализа кода

### 9.3. Метрики успешной миграции
- Скорость внедрения новых фич
- Количество ошибок в production
- Покрытие кода тестами
- Скорость сборки и работы приложения

## 10. Справочные материалы

### 10.1. Основные паттерны FSD
- Слайсинг по функциональности
- Инверсия зависимостей
- Публичные API для модулей
- Композиция компонентов

### 10.2. Best practices при работе с FSD
- Минимальные импорты между слоями
- Отсутствие циклических зависимостей
- Чистые функции и компоненты
- Типизация всех данных

### 10.3. Ресурсы для изучения
- Документация Feature-Sliced Design
- Примеры проектов на FSD
- Статьи и руководства

---

**Дополнительные примечания:**
- Этот план миграции является живым документом и может корректироваться в процессе работы
- Приоритезация элементов для миграции должна основываться на бизнес-критичности компонентов
- Рекомендуется вести подробную документацию всех изменений 