# Детальный план миграции на Feature-Sliced Design (FSD)

## Стратегия миграции

Миграция будет проводиться постепенно, следуя принципу "перестройки корабля в море". На каждом этапе:

1. **Параллельное существование**: реализуем новые компоненты по FSD архитектуре, пока старая структура продолжает работать
2. **Постепенное внедрение**: для каждого модуля - создаём FSD-версию, тестируем, затем интегрируем
3. **Переключение с помощью обёрток**: временные адаптеры для совместимости нового кода со старым
4. **Удаление старого кода**: только после полной проверки работоспособности нового решения

## 1. Подготовка инфраструктуры и конфигурация (0-й этап)

### 1.1. Настройка директорий и конфигурации
- ✅ Создание базовой структуры директорий FSD в `/src`
- ⬜ Обновление tsconfig.json с поддержкой новых путей:
  ```json
  {
    "compilerOptions": {
      "paths": {
        "@/*": ["./src/*"],
        "@shared/*": ["./src/shared/*"],
        "@entities/*": ["./src/entities/*"],
        "@features/*": ["./src/features/*"],
        "@widgets/*": ["./src/widgets/*"],
        "@pages/*": ["./src/pages/*"],
        "@app/*": ["./src/app/*"]
      }
    }
  }
  ```
- ⬜ Создание src/app/index.tsx с ре-экспортом провайдеров

### 1.2. Настройка зависимостей и инструментов
- ✅ Установка Zustand для управления состоянием
- ✅ Установка React Query для работы с сервером
- ✅ Установка Zod для валидации данных
- ⬜ Создание утилит для тестирования FSD-модулей
- ⬜ Обновление ESLint для поддержки слоевой архитектуры

## 2. Детальная миграция слоя shared

### 2.1. Создание базовых shared-модулей
- ✅ Создание `shared/config`: константы, конфигурация
- ✅ Создание `shared/lib/zustand`: утилиты для Zustand
- ✅ Создание `shared/api`: типизированный API клиент

### 2.2. Миграция утилит из `/lib` в `/src/shared/lib`
- ✅ Модуль `shared/lib/db`:
  - ✅ Создание `shared/lib/db/index.ts`
  - ✅ Создание `shared/lib/db/connection.ts` (из lib/db.ts)
  - ✅ Создание `shared/lib/db/queries.ts` (обёртки для SQL запросов)
  - ✅ Создание `shared/lib/db/transaction.ts` (транзакции)

- ✅ Модуль `shared/lib/jwt`:
  - ✅ Создание `shared/lib/jwt/index.ts`
  - ✅ Создание `shared/lib/jwt/tokens.ts` (генерация/верификация токенов)
  - ✅ Создание `shared/lib/jwt/cookies.ts` (работа с куками)

- ✅ Модуль `shared/lib/logger`:
  - ✅ Создание `shared/lib/logger/index.ts` 
  - ✅ Создание `shared/lib/logger/server.ts` (серверное логирование)
  - ✅ Создание `shared/lib/logger/client.ts` (клиентское логирование)

- ✅ Модуль `shared/lib/web3`:
  - ✅ Создание `shared/lib/web3/index.ts`
  - ✅ Создание `shared/lib/web3/providers.ts` (поддержка провайдеров)
  - ✅ Создание `shared/lib/web3/signature.ts` (подпись сообщений)
  - ✅ Создание `shared/lib/web3/chains.ts` (конфигурация цепей)

- ✅ Модуль `shared/lib/github`:
  - ✅ Создание `shared/lib/github/index.ts`
  - ✅ Создание `shared/lib/github/api.ts` (взаимодействие с GitHub API)
  - ✅ Создание `shared/lib/github/sync.ts` (синхронизация данных с GitHub)

- ✅ Модуль `shared/lib/openai`:
  - ✅ Создание `shared/lib/openai/index.ts`
  - ✅ Создание `shared/lib/openai/api.ts` (взаимодействие с OpenAI API)
  - ✅ Создание `shared/lib/openai/translate.ts` (функции перевода)

### 2.3. Создание UI-компонентов слоя shared
- ✅ Модуль `shared/ui/button` (базовая кнопка, перенос и актуализация кода)
- ✅ Модуль `shared/ui/input` (поле ввода, перенос и актуализация кода)
- ✅ Модуль `shared/ui/modal` (модальное окно, перенос и актуализация кода, экспорт всех subcomponents)
- ✅ Модуль `shared/ui/notification` (уведомление, перенос и актуализация кода, экспорт всех subcomponents)
- ✅ Модуль `shared/ui/select` (выпадающий список, перенос и актуализация кода, экспорт всех subcomponents)
- ✅ Модуль `shared/ui/dropdown-menu` (выпадающее меню, перенос и актуализация кода, экспорт всех subcomponents)
- ✅ Модуль `shared/ui/checkbox` (чекбокс, перенос и актуализация кода)
- ✅ Модуль `shared/ui/radio-group` (группа радиокнопок, перенос и актуализация кода)
- ✅ Модуль `shared/ui/switch` (переключатель, перенос и актуализация кода)
- ✅ Модуль `shared/ui/avatar` (аватар, перенос и актуализация кода)
- ✅ Модуль `shared/ui/badge` (бейдж, перенос и актуализация кода)
- ✅ Модуль `shared/ui/separator` (разделитель, перенос и актуализация кода)
- ✅ Модуль `shared/ui/label` (метка, перенос и актуализация кода)
- ✅ Модуль `shared/ui/textarea` (текстовое поле, перенос и актуализация кода)
- ✅ Модуль `shared/ui/tooltip` (всплывающая подсказка, перенос и актуализация кода)
- ✅ Модуль `shared/ui/popover` (всплывающее окно, перенос и актуализация кода)
- ✅ Модуль `shared/ui/progress` (индикатор прогресса, перенос и актуализация кода)
- ✅ Модуль `shared/ui/skeleton` (скелетон, перенос и актуализация кода)
- ✅ Модуль `shared/ui/slider` (ползунок, перенос и актуализация кода)
- ✅ Модуль `shared/ui/tabs` (вкладки, перенос и актуализация кода)
- ✅ Модуль `shared/ui/toggle` (переключатель-кнопка, перенос и актуализация кода)
- ✅ Модуль `shared/ui/toggle-group` (группа переключателей, перенос и актуализация кода)
- ✅ Модуль `shared/ui/accordion` (аккордеон, перенос и актуализация кода)
- ✅ Модуль `shared/ui/card` (карточка, перенос и актуализация кода)
- ✅ Модуль `shared/ui/form` (форма, перенос и актуализация кода)

## 3. Детальная миграция слоя entities

### 3.1. Модуль `entities/user`
- ✅ Создание модели (types.ts, store.ts)
- ✅ Создание API-клиента (userApi.ts)
- ✅ Создание UI-компонентов:
  - ✅ UserAvatar
  - ✅ UserInfo
- ⬜ Дополнительные компоненты:
  - ⬜ UserBadge (бейджи ролей пользователя)
  - ⬜ UserCard (карточка пользователя)
  - ⬜ UserList (список пользователей)

### 3.2. Модуль `entities/page`
- ⬜ Создание модели:
  - ⬜ types.ts (типы/схемы страницы)
  - ⬜ store.ts (локальный стор для страниц)
  - ⬜ consts.ts (константы для страниц)
- ⬜ Создание API-клиента:
  - ⬜ pageApi.ts (CRUD операции для страниц)
- ⬜ Создание UI-компонентов:
  - ⬜ PageCard (карточка страницы)
  - ⬜ PageInfo (мета-информация о странице)
  - ⬜ PageContent (контент страницы с Markdown)
  - ⬜ PageTitle (заголовок страницы)
  - ⬜ PageStats (статистика просмотров и редактирований)

### 3.3. Модуль `entities/page-version`
- ⬜ Создание модели:
  - ⬜ types.ts (типы/схемы версии)
  - ⬜ store.ts (локальный стор для версий)
- ⬜ Создание API-клиента:
  - ⬜ versionApi.ts (операции с версиями)
- ⬜ Создание UI-компонентов:
  - ⬜ VersionCard (карточка версии)
  - ⬜ VersionDiff (сравнение версий)
  - ⬜ VersionInfo (информация о версии)

### 3.4. Модуль `entities/translation`
- ⬜ Создание модели:
  - ⬜ types.ts (типы/схемы перевода)
  - ⬜ store.ts (локальный стор для переводов)
- ⬜ Создание API-клиента:
  - ⬜ translationApi.ts (операции с переводами)
- ⬜ Создание UI-компонентов:
  - ⬜ TranslationSelector (выбор перевода)
  - ⬜ TranslationBadge (бейдж языка перевода)

### 3.5. Модуль `entities/settings`
- ⬜ Создание модели:
  - ⬜ types.ts (типы/схемы настроек)
  - ⬜ store.ts (локальный стор для настроек)
- ⬜ Создание API-клиента:
  - ⬜ settingsApi.ts (операции с настройками)
- ⬜ Создание UI-компонентов:
  - ⬜ SettingsCard (карточка настройки)
  - ⬜ SettingsSection (секция настроек)

### 3.6. Модуль `entities/user/api`:
- ✅ Перенос кода из lib/user-service.ts (основные функции, импорты актуализированы)

### 3.7. Модуль `entities/page/api`:
- ✅ Перенос кода из lib/page-service.ts (основные функции, импорты актуализированы)

## 4. Детальная миграция слоя features

### 4.1. Модуль `features/auth`
- ✅ Создание модели (types.ts, store.ts)
- ✅ Создание API-клиента (authApi.ts)
- ⬜ Создание UI-компонентов:
  - ⬜ Web3Connect (подключение Web3-кошелька):
    - ⬜ Web3ConnectButton (кнопка подключения)
    - ⬜ Web3ConnectModal (модальное окно)
  - ⬜ SignMessage (подписание сообщения):
    - ⬜ SignMessageForm (форма подписи сообщения)
  - ⬜ AuthStatus (статус аутентификации):
    - ⬜ AuthStatusBadge (бейдж статуса)
    - ⬜ AuthStatusDropdown (выпадающее меню)

### 4.2. Модуль `features/page`

#### 4.2.1. Подмодуль `features/page/create`
- ⬜ Создание модели:
  - ⬜ types.ts (типы форм создания)
  - ⬜ validations.ts (валидация полей)
  - ⬜ store.ts (состояние создания страницы)
- ⬜ Создание UI-компонентов:
  - ⬜ PageCreateForm (форма создания страницы)
  - ⬜ PageCreateButton (кнопка создания)
  - ⬜ PageCreatePreview (предпросмотр)

#### 4.2.2. Подмодуль `features/page/edit`
- ⬜ Создание модели:
  - ⬜ types.ts (типы редактирования)
  - ⬜ store.ts (состояние редактирования)
- ⬜ Создание UI-компонентов:
  - ⬜ PageEditor (редактор страницы)
  - ⬜ PageEditForm (форма редактирования)
  - ⬜ PageEditControls (кнопки сохранения, отмены)

#### 4.2.3. Подмодуль `features/page/delete`
- ⬜ Создание модели:
  - ⬜ store.ts (состояние удаления)
- ⬜ Создание UI-компонентов:
  - ⬜ PageDeleteButton (кнопка удаления)
  - ⬜ PageDeleteConfirmation (подтверждение удаления)

#### 4.2.4. Подмодуль `features/page/translate`
- ⬜ Создание модели:
  - ⬜ types.ts (типы перевода)
  - ⬜ store.ts (состояние перевода)
- ⬜ Создание UI-компонентов:
  - ⬜ TranslateButton (кнопка перевода)
  - ⬜ TranslateLanguageSelector (выбор языка)
  - ⬜ TranslationProgress (прогресс перевода)

### 4.3. Модуль `features/search`
- ⬜ Создание модели:
  - ⬜ types.ts (типы поиска)
  - ⬜ store.ts (состояние поиска)
- ⬜ Создание UI-компонентов:
  - ⬜ SearchForm (форма поиска)
  - ⬜ SearchFilters (фильтры поиска)
  - ⬜ SearchSuggestions (подсказки при поиске)

## 5. Детальная миграция слоя widgets

### 5.1. Модуль `widgets/header`
- ⬜ Создание компонента Header:
  - ⬜ index.ts (экспорт)
  - ⬜ ui/Header.tsx (основной компонент)
  - ⬜ ui/Logo.tsx (логотип)
  - ⬜ ui/Navigation.tsx (навигация)
  - ⬜ ui/UserMenu.tsx (меню пользователя)
  - ⬜ ui/SearchBar.tsx (строка поиска)

### 5.2. Модуль `widgets/sidebar`
- ⬜ Создание компонента Sidebar:
  - ⬜ index.ts (экспорт)
  - ⬜ ui/Sidebar.tsx (основной компонент)
  - ⬜ ui/SidebarMenu.tsx (меню сайдбара)
  - ⬜ ui/SidebarFooter.tsx (футер сайдбара)
  - ⬜ ui/SidebarToggle.tsx (переключатель сайдбара)

### 5.3. Модуль `widgets/markdown-editor`
- ⬜ Создание компонента MarkdownEditor:
  - ⬜ index.ts (экспорт)
  - ⬜ ui/MarkdownEditor.tsx (основной компонент)
  - ⬜ ui/Toolbar.tsx (панель инструментов)
  - ⬜ ui/Preview.tsx (предпросмотр)
  - ⬜ lib/shortcuts.ts (горячие клавиши)
  - ⬜ lib/plugins.ts (плагины для редактора)
  - ⬜ model/store.ts (состояние редактора)

### 5.4. Модуль `widgets/version-history`
- ⬜ Создание компонента VersionHistory:
  - ⬜ index.ts (экспорт)
  - ⬜ ui/VersionHistory.tsx (основной компонент)
  - ⬜ ui/VersionList.tsx (список версий)
  - ⬜ ui/VersionCompare.tsx (сравнение версий)
  - ⬜ model/store.ts (состояние истории версий)

### 5.5. Модуль `widgets/recent-pages`
- ⬜ Создание компонента RecentPages:
  - ⬜ index.ts (экспорт)
  - ⬜ ui/RecentPages.tsx (основной компонент)
  - ⬜ ui/RecentPagesList.tsx (список страниц)
  - ⬜ model/store.ts (состояние недавних страниц)

### 5.6. Модуль `widgets/popular-pages`
- ⬜ Создание компонента PopularPages:
  - ⬜ index.ts (экспорт)
  - ⬜ ui/PopularPages.tsx (основной компонент)
  - ⬜ ui/PopularPagesList.tsx (список страниц)
  - ⬜ model/store.ts (состояние популярных страниц)

## 6. Детальная миграция слоя app

### 6.1. Модуль `app/providers`
- ⬜ Создание композиционного провайдера:
  - ⬜ index.ts (экспорт композиции провайдеров)
  - ⬜ compose.tsx (компонент композиции провайдеров)

#### 6.1.1. Провайдер `app/providers/auth`
- ✅ Создание AuthProvider:
  - ✅ AuthProvider.tsx (компонент)
  - ✅ index.ts (экспорт)

#### 6.1.2. Провайдер `app/providers/web3`
- ⬜ Создание Web3Provider:
  - ⬜ Web3Provider.tsx (компонент)
  - ⬜ lib/connectWallet.ts (функции подключения)
  - ⬜ lib/signMessage.ts (функции подписи)
  - ⬜ index.ts (экспорт)

#### 6.1.3. Провайдер `app/providers/theme`
- ⬜ Создание ThemeProvider:
  - ⬜ ThemeProvider.tsx (компонент)
  - ⬜ lib/colorScheme.ts (функции работы с цветовой схемой)
  - ⬜ index.ts (экспорт)

### 6.2. Модуль `app/styles`
- ⬜ Создание стилей:
  - ⬜ globals.css (глобальные стили)
  - ⬜ variables.css (CSS-переменные)
  - ⬜ themes.css (темы)

## 7. Детальная миграция слоя pages

### 7.1. Модуль `pages/home`
- ⬜ Создание компонентов:
  - ⬜ index.ts (экспорт)
  - ⬜ ui/HomePage.tsx (основной компонент)
  - ⬜ ui/Hero.tsx (герой-секция)
  - ⬜ model/store.ts (состояние главной страницы)

### 7.2. Модуль `pages/wiki-page`
- ⬜ Создание компонентов:
  - ⬜ index.ts (экспорт)
  - ⬜ ui/WikiPage.tsx (основной компонент)
  - ⬜ ui/PageHeader.tsx (заголовок страницы)
  - ⬜ ui/PageActions.tsx (действия на странице)
  - ⬜ ui/PageSections.tsx (секции страницы)
  - ⬜ model/store.ts (состояние страницы wiki)

### 7.3. Модуль `pages/create-page`
- ⬜ Создание компонентов:
  - ⬜ index.ts (экспорт)
  - ⬜ ui/CreatePage.tsx (основной компонент)
  - ⬜ model/store.ts (состояние создания страницы)

### 7.4. Модуль `pages/settings`
- ⬜ Создание компонентов:
  - ⬜ index.ts (экспорт)
  - ⬜ ui/SettingsPage.tsx (основной компонент)
  - ⬜ ui/SettingsTabs.tsx (вкладки настроек)
  - ⬜ model/store.ts (состояние страницы настроек)

## 8. Интеграция с API-роутами Next.js

### 8.1. Стратегия интеграции
- ⬜ Создание прослойки между старыми API-роутами и новыми сервисами
- ⬜ Постепенное обновление API-роутов для использования новых сервисов

### 8.2. Обновление API-роутов
- ⬜ Обновление `/app/api/auth/*` для использования `features/auth`
- ⬜ Обновление `/app/api/users/*` для использования `entities/user`
- ⬜ Обновление `/app/api/pages/*` для использования `entities/page`
- ⬜ Обновление `/app/api/translate/*` для использования `entities/translation`
- ⬜ Обновление `/app/api/settings/*` для использования `entities/settings`

## 9. Стратегия тестирования

### 9.1. Тестирование shared-слоя
- ⬜ Юнит-тесты для утилит и хелперов
- ⬜ Тесты для API-клиента

### 9.2. Тестирование entities-слоя
- ⬜ Тесты схем валидации
- ⬜ Тесты сторов (Zustand)
- ⬜ Тесты UI-компонентов

### 9.3. Тестирование features-слоя
- ⬜ Интеграционные тесты для фич
- ⬜ Тестирование форм и действий пользователя

### 9.4. E2E тестирование
- ⬜ Тесты основных пользовательских сценариев
- ⬜ Тесты с рабочей базой данных

## 10. Постепенное внедрение и переключение

### 10.1. Создание адаптеров для совместимости
- ⬜ Адаптеры для старых компонентов к новым данным
- ⬜ Адаптеры для новых компонентов к старым данным

### 10.2. Стратегия переключения
- ⬜ Feature flags для переключения между старыми и новыми компонентами
- ⬜ Постепенная замена старых компонентов на новые
- ⬜ Проверка каждого компонента после замены

### 10.3. Окончательная миграция
- ⬜ Удаление старых компонентов и файлов
- ⬜ Удаление адаптеров
- ⬜ Финальная проверка приложения

## 11. Документация и поддержка

### 11.1. Документирование архитектуры
- ⬜ Обновление ARCHITECTURE.md с описанием FSD
- ⬜ Документирование конвенций и правил для каждого слоя

### 11.2. Справочники для разработчиков
- ⬜ Создание руководства по добавлению новых фич
- ⬜ Создание чеклистов для проверки соответствия FSD

## Приоритеты и зависимости задач

1. **Первый этап** (инфраструктура и shared):
   - Настройка tsconfig.json
   - Перенос базовых утилит из `/lib` в `/src/shared/lib`

2. **Второй этап** (основные сущности):
   - Завершение миграции `entities/user`
   - Создание `entities/page`
   - Создание `entities/page-version`

3. **Третий этап** (основные фичи):
   - Завершение миграции `features/auth`
   - Создание `features/page/create` и `features/page/edit`
   - Создание провайдеров в `app/providers`

4. **Четвертый этап** (виджеты и страницы):
   - Создание основных виджетов (header, sidebar, markdown-editor)
   - Создание основных страниц (home, wiki-page)

5. **Пятый этап** (интеграция и тестирование):
   - Адаптация API-роутов
   - Тестирование всех компонентов
   - Постепенная замена старых компонентов

6. **Финальный этап** (зачистка и документация):
   - Удаление старых компонентов и файлов
   - Документирование архитектуры
   - Финальное E2E тестирование 

- ⬜ Модуль `shared/lib/session`:
  - ⬜ Создание `shared/lib/session/index.ts` (работа с сессиями пользователей)
✅ Модуль `shared/lib/session`:
✅ Создание `shared/lib/session/index.ts` (перенос и актуализация кода)

✅ Модуль `shared/lib/utils`:
✅ Создание `shared/lib/utils/index.ts` (перенос и актуализация кода)

✅ Модуль `shared/lib/validation`:
✅ Создание `shared/lib/validation/index.ts` (перенос и актуализация кода)

✅ Модуль `shared/api/utils`:
✅ Создание `shared/api/utils/index.ts` (перенос и актуализация кода)

✅ Модуль `features/page/translate/api`:
✅ Перенос кода из lib/translate-service.ts (отсутствует, создана заглушка) 